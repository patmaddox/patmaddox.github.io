---
layout: post
title: Behavioral Methods in ActiveRecord
date: 2010-10-29 18:05:44.000000000 -06:00
categories: []
tags: []
status: publish
type: post
published: true
meta:
  _edit_last: '2'
  _wp_rp_related_posts_query_result_cache_expiration: '1443657682'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:3:"222";s:5:"score";s:18:"17.424136593737003";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:2:"44";s:5:"score";s:17:"15.85861791520548";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:3:"230";s:5:"score";s:18:"11.496169443258182";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:3:"256";s:5:"score";s:17:"11.23042288091759";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:3:"423";s:5:"score";s:16:"10.8232249699835";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"1066";s:5:"score";s:17:"10.55616218476671";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:3:"234";s:5:"score";s:18:"10.070785890443965";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"1007";s:5:"score";s:17:"9.130778631952493";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:3:"184";s:5:"score";s:17:"8.457834158677809";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"1028";s:5:"score";s:17:"8.190771373461022";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:3:"202";s:5:"score";s:17:"7.400783756527671";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:3:"928";s:5:"score";s:18:"6.8679744089702925";}}
  _wp_rp_related_posts_query_result_cache_4: a:8:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:3:"199";s:5:"score";s:17:"19.18670608096386";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:3:"222";s:5:"score";s:18:"18.146823166836548";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:2:"65";s:5:"score";s:18:"16.461401774172504";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:2:"99";s:5:"score";s:18:"14.363137311197507";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:2:"44";s:5:"score";s:18:"14.363137311197507";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:3:"256";s:5:"score";s:18:"13.242525949304303";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:3:"197";s:5:"score";s:17:"12.91266632090565";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:3:"208";s:5:"score";s:18:"12.739897092632146";}}
author:
  login: pat
  email: patmaddox@me.com
  display_name: pat
  first_name: Pat
  last_name: Maddox
excerpt: !ruby/object:Hpricot::Doc
  options: {}
---
<p>If you&#8217;ve followed my blog or seen me speak, you may already know that I&#8217;m not the biggest fan of ActiveRecord callbacks.  If you didn&#8217;t know that, well, I&#8217;m not the biggest fan of ActiveRecord callbacks :)</p>
<p>As much as I love Rails, and in particular convention over configuration, it bums me out when people sacrifice basic OOP design in the name of convention over configuration [1].  Let me share a brief example.</p>
<p>Let&#8217;s say we&#8217;re building an app that allows people to subscribe to magazines.  The three models we&#8217;ll use are Account, Magazine, and Subscription.  They&#8217;re related as follows:</p>
<pre><code>class Account &lt; ActiveRecord::Base
  has_many :subscriptions
  has_many :magazines, :through =&gt; :subscriptions
end

class Subscription &lt; ActiveRecord::Base
  belongs_to :account
  belongs_to :magazine
end

class Magazine
  has_many :subscriptions
  has_many :accounts, :through =&gt; :subscriptions
end
</code></pre>
<p>The Rails convention for creating a subscription would be</p>
<pre><code>Subscription.create!(:account =&gt; some_account_object, :magazine =&gt; some_magazine_object).
</code></pre>
<p>So now that we&#8217;ve got the model set up, how do we send a confirmation email to the user when they subscribe to a magazine?  Conventional Rails code would be something like this:</p>
<pre><code>class Subscription &lt; ActiveRecord::Base
  belongs_to :account
  belongs_to :magazine

  after_create :deliver_confirmation_email

  def deliver_confirmation_email
    SubscriptionMailer.deliver_confirmation_email self
  end
end
</code></pre>
<p>Nothing surprising there.</p>
<p>In the interest of keeping this short, I&#8217;m just going to show an alternative approach to solving this problem, and keep the commentary to a minumum.  It&#8217;s pretty simple: just write a behavioral method.</p>
<pre><code>class Magazine
  has_many :subscriptions
  has_many :accounts, :through =&gt; :subscriptions

  def subscribe(account)
    subscription = Subscription.create! :magazine =&gt; self, :account =&gt; account
    SubscriptionMailer.deliver_confirmation_email subscription
  end
end
</code></pre>
<p>This approach neatly solves the callback problem, and the resulting code stays true to the domain language.  People don&#8217;t create a subscription to a newspaper, they <em>subscribe</em> to a newspaper.  If there&#8217;s a domain-specific action called <em>subscribe</em>, shouldn&#8217;t there be a corresponding method somewhere in the code base?  I think so.</p>
<p>There are, of course tradeoffs.  We&#8217;re sacrificing the automatic transaction semantics that callbacks give us.  It doesn&#8217;t work with resource_controller, or other frameworks that rely on conventions.  Rails programmers new to your team might be confused by the use of extra methods instead of just going through the ActiveRecord API.  The first two I think can be solved with a little bit of code.  If you&#8217;re doing something like this a lot, you&#8217;ll figure out a way to make it nice and clean.  The third one is easily solved by pair programming (as is basically every problem of knowledge transfer across a team).</p>
<p>One question you&#8217;ll encounter with this approach is where to place the methods.  After all, we could have just as easily chosen <strong>account.subscribe(magazine)</strong>, and indeed reading that aloud is perhaps more natural than <strong>magazine.subscribe(account)</strong>.  I&#8217;ve found the book <a href="http://www.amazon.com/Streamlined-Object-Modeling-Patterns-Implementation/dp/0130668397/ref=sr_1_1?ie=UTF8&amp;s=books&amp;qid=1288306495&amp;sr=8-1">Streamlined Object Modeling</a> to be an excellent resource for thinking through this kind of problem.  It goes into great detail on how and why to structure different kinds of object collaborations.</p>
<hr />
<p>[1] Any suggestions for how to shorten &#8220;convention over configuration?&#8221;  CoC has an unfortunate pronunciation&#8230; conv / conf maybe?  We need a convention for this.</p>
