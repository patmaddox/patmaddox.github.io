---
layout: post
title: Declarative Workflow in Rails
date: 2007-01-13 23:55:27.000000000 -07:00
categories: []
tags: []
status: publish
type: post
published: true
meta:
  _edit_last: '2'
  _wp_rp_related_posts_query_result_cache_expiration: '1443638992'
  _wp_rp_related_posts_query_result_cache_4: a:8:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:4:"1007";s:5:"score";s:18:"18.820683181188073";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:2:"59";s:5:"score";s:17:"13.36062496553231";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:3:"463";s:5:"score";s:18:"12.695939279304941";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:4:"1121";s:5:"score";s:18:"11.572001315235344";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:2:"55";s:5:"score";s:18:"11.064440273696937";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:3:"218";s:5:"score";s:17:"10.86335781555663";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:3:"244";s:5:"score";s:18:"10.618153171068517";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:2:"65";s:5:"score";s:18:"10.399754587469568";}}
author:
  login: pat
  email: patmaddox@me.com
  display_name: pat
  first_name: Pat
  last_name: Maddox
excerpt: !ruby/object:Hpricot::Doc
  options: {}
---
<p>You&#8217;ve been contracted by a modeling agency to build an application that manages supermodels&#8217; profiles.  They want models to be able to upload their info, as well as let prospective clients browse the various models.</p>
<p>The agency suggests that models fill out their info in pieces.  Models tend to be&#8230;well, they have a tough time focusing, so they should only be faced with one piece of info at a time.</p>
<p>So how do we do it?  Well, here&#8217;s a lame first attempt:</p>
<p><script src="http://gist.github.com/482346.js?file=gistfile1.rb"></script>
<p>Here&#8217;s a view template:</p>
<p><script src="http://gist.github.com/482347.js?file=gistfile1.erb"></script>
<p>That is so weak sauce.  First of all it&#8217;s not RESTful, and I like REST.  If you published an API, it&#8217;d be tough to use.  Clients would have to know about all these different actions, which parameters to pass at each step, etc.  Maybe you want to create another interface at some point, one that consolidates a couple steps.  You could, but there&#8217;d be massive duplication both of code and functionality.  On top of that, the steps are all coupled to each other.  Finally, it&#8217;ll be really tough to coordinate steps between controllers.</p>
<h2>REST is Good, Declarative is Good</h2>
<p>I want a RESTful interface, so I get all of its benefits.  I want an explicit workflow with explicit steps, rather than having that concept be hidden behind controller actions.  I want it to be declarative, so it&#8217;s easy to read and write.</p>
<p>Here&#8217;s something I whipped up in a couple of hours.  Check it out, and then I&#8217;ll discuss it a bit more.</p>
<p><script src="http://gist.github.com/482349.js?file=gistfile1.rb"></script>
<p>One major thing you&#8217;ll notice is that we&#8217;re keeping the same basic controller actions, with the same controller code.  We don&#8217;t have a ton of actions, there are no steps that forward on to the next step.  The controller code is the same, clean code that we know and love from REST.</p>
<p>And of course there&#8217;s the explicit workflow.  The first step is to collect the supermodel&#8217;s name.  Do that by showing her the name form.  After she&#8217;s entered that, collect her birth date.  Do that by showing her the birth date form.</p>
<p>None of the steps are coupled to each other.  You know which step goes when, because of where it sits in the workflow, but the steps don&#8217;t even have a clue the others exist.  If you want to change the order, you just move them around.</p>
<p>The views are standard forms, either POSTing to create or PUTing to update.  http_verb is just a helper method that figures out which verb to use.</p>
<p><script src="http://gist.github.com/482350.js?file=gistfile1.erb"></script>
<p>How does each step know when to execute?  It&#8217;s really simple&#8230;</p>
<p><script src="http://gist.github.com/482352.js?file=gistfile1.rb"></script>
<p>If the resource doesn&#8217;t pass a particular step, then it will do whatever is specified in the block passed to the step (render :templae =&gt; &#8220;supermodels/name&#8221; in this case).  The naming sucks - maybe it could be a Specification and satisfied_by?</p>
<p>Your app is still generally useful because it&#8217;s not tied to the workflow.  You can bypass the entire workflow by just POSTing all the attributes of a Supermodel.  You can combine steps by PUTting just a couple of the attributes at once.</p>
<p>The workflow is just a bunch of objects, so you can store workflows in the DB.  Then you can do cool stuff like create an admin interface to maintain workflows.  Imagine you&#8217;re at a page that has all the possible workflow steps.  Add/delete/rearrange steps with some AJAXy goodness.</p>
<p>A workflow can easily cross multiple controllers, it&#8217;s not limited to the current controller.</p>
<p>This does break the semantics of REST with the create method&#8230;instead of redirecting to the newly created resource, it redirects to the edit URL.  That&#8217;s a minor thing though and can easily be changed.  If the new resource satisfies the workflow, redirect to the new resource.  If not, go to the edit form.</p>
<h2>Still to come</h2>
<p>This is nowhere near complete.  It&#8217;s just the half-baked result of an idea I had for my job.  I&#8217;m happy to answer any questions or take any feedback, just know that this is a really early, basic implementation.  Considering that workflow management is a key part of our app, though, you can expect some major developments next week.</p>
