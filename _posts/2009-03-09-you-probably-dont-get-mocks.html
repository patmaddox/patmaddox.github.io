---
layout: post
title: You Probably Don't Get Mocks
date: 2009-03-09 15:16:26.000000000 -06:00
categories: []
tags: []
status: publish
type: post
published: true
meta:
  _edit_last: '2'
  _wp_rp_related_posts_query_result_cache_expiration: '1443763397'
  _wp_rp_related_posts_query_result_cache_4: a:8:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:3:"895";s:5:"score";s:18:"18.619600723047768";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:3:"146";s:5:"score";s:18:"17.589690688486936";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:3:"928";s:5:"score";s:18:"12.382931531410293";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:4:"1121";s:5:"score";s:18:"10.836551754846777";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:3:"101";s:5:"score";s:18:"10.836551754846777";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:3:"190";s:5:"score";s:16:"9.69546203803569";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:2:"84";s:5:"score";s:16:"9.69546203803569";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:3:"180";s:5:"score";s:17:"9.330818924392608";}}
author:
  login: pat
  email: patmaddox@me.com
  display_name: pat
  first_name: Pat
  last_name: Maddox
excerpt: !ruby/object:Hpricot::Doc
  options: {}
---
<p>I&#8217;m watching <a href="http://fhwang.net/">Francis Hwang</a>&#8217;s talk from RubyConf 2008 titled <a href="http://rubyconf2008.confreaks.com/testing-heresies.html">&#8220;Testing Heresies.&#8221;</a>  He discusses his reasons for not using mock objects, and commits a common error when trashing mocks: he shows crappy examples which evidently serve as proof of why the technique sucks.</p>
<p>To start, let&#8217;s look at the two main arguments people make for why mocks suck:</p>
<ol>
<li>They duplicate the code under test</li>
<li>Objects can get out of sync when interfaces change</li>
</ol>
<p>Here&#8217;s a code example Francis gives that uses mocks:</p>
<p><script src="http://gist.github.com/495686.js?file=gistfile1.rb"></script>
<p>Before he gets into it, he says something along the lines of &#8220;Please let me know if I&#8217;m mischaracterizing the approach.&#8221;  Too bad I wasn&#8217;t there.  Yes, you COMPLETELY mischaracterized the approach.</p>
<p>If you&#8217;re using mocks like this, you&#8217;re doing it wrong.  Very, very wrong.  Here&#8217;s how you would really use mocks:</p>
<p><script src="http://gist.github.com/495689.js?file=gistfile1.rb"></script>
<p>Better?</p>
<p>Then you would have a model level spec:</p>
<p><script src="http://gist.github.com/495690.js?file=gistfile1.rb"></script>
<p>This is one example where I&#8217;ll cave in to the whole &#8220;mocks duplicate the code under test&#8221; argument.  If your mocking code sucks, and your mocking code duplicates your production code, then guess what?  Your production code sucks!</p>
<p>The value that mocking provides in this case is <em>writing the code you wish you had</em>.  Do you really wish you had a find(:select =&gt; &#8230;, :conditions =&gt; &#8230;) in your controller code?  Of course not! (I hope not, anyway).  You don&#8217;t have to use mocks to get the APIs you want (refactoring is still an option ;) but it&#8217;s very, very helpful.</p>
<p>Bottom line: mocks aren&#8217;t inherently evil.  I could take Francis&#8217;s example as proof of why Ruby, Rails, and RSpec all suck, and it would be just as valid as concluding that mocks suck.  The only things that sucked here are the example and the production code.</p>
<h2>Code gets out of sync</h2>
<p>No it doesn&#8217;t.  Let me give you a very quick rundown of the code you would write to implement this feature.</p>
<h4>1. Write a cucumber feature</h4>
<p><script src="http://gist.github.com/495692.js?file=gistfile1.feature"></script><br />
<h4>2. Write the controller spec, mocking out the finder, implement controller</h4>
<h4>3. Write model specs for the finder, implement finder</h4>
<p>Now when someone says &#8220;but if I rename the finder, the controller spec will continue to pass!  Mocks are horrible!!&#8221;  You can point to the acceptance test that fails.  Holy quality software, batman!</p>
