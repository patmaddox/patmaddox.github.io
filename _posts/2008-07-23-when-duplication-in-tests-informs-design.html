---
layout: post
title: When Duplication in Tests Informs Design
date: 2008-07-23 14:34:27.000000000 -06:00
categories: []
tags: []
status: publish
type: post
published: true
meta:
  _edit_last: '2'
  _wp_rp_related_posts_query_result_cache_expiration: '1441213331'
  _wp_rp_related_posts_query_result_cache_4: a:8:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:3:"172";s:5:"score";s:18:"17.732608616313296";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:3:"170";s:5:"score";s:18:"17.589690688486936";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:3:"190";s:5:"score";s:17:"13.50354289335867";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:3:"220";s:5:"score";s:18:"13.439366264186702";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:3:"889";s:5:"score";s:18:"12.485518120130223";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:3:"107";s:5:"score";s:18:"11.782722346413065";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:3:"166";s:5:"score";s:18:"10.998016956340347";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:3:"160";s:5:"score";s:18:"10.998016956340347";}}
author:
  login: pat
  email: patmaddox@me.com
  display_name: pat
  first_name: Pat
  last_name: Maddox
excerpt: !ruby/object:Hpricot::Doc
  options: {}
---
</p>
<p>Everybody knows why duplication is bad.  Usually, anyway.  In tests</p>
<p>I&#8217;m often comfortable with duplication if it makes the tests more</p>
<p>readable.  There has to be a line somewhere though, right?  Certain</p>
<p>kinds of duplication are good while some are bad.  It&#8217;s not always</p>
<p>easy to tell the difference between the good and bad kinds.</p></p>
<p>Identifying duplication as good or bad is interesting, but it&#8217;s not</p>
<p>what I want to focus on right now.  More interesting to me is how bad</p>
<p>duplication is a sign that your code could use some design</p>
<p>improvements.  Consider the following code:</p>
<p><script src="http://gist.github.com/495392.js?file=gistfile1.rb"></script></p>
<p>Even in such a trivial example, we can improve our code&#8217;s design with</p>
<p>a little refactoring:</p>
<p><script src="http://gist.github.com/495394.js?file=gistfile1.rb"></script>
<p>Okay, you&#8217;re right.  Not all that interesting.</p></p>
<p>Duplication in production code is an obvious sign that the design can</p>
<p>be improved.  It&#8217;s a smell in its own right, and the single best thing</p>
<p>you can do at that point is to get rid of it.</p></p>
<p>What is interesting to me is that duplication in <em>test</em> code can be a</p>
<p>sign that your design can be improved.  Let&#8217;s take a look at an</p>
<p>example that came up at work the other day (names changed to protect</p>
<p>the NDA-bound).  It&#8217;s an action that shows a list of published posts to</p>
<p>unauthenticated users, and allows authenticated users to view either</p>
<p>all posts or only certain filtered posts.</p>
<p><script src="http://gist.github.com/495396.js?file=gistfile1.rb"></script></p>
<p>Not too bad.  What do the specs look like?  In order to fully test</p>
<p>this action, we need to write six examples:</p>
<ul>
<li>one when not logged in</li>
<li>one when logged in, no filter specified</li>
<li>one when published filter is specified</li>
<li>one when pending filter is specified</li>
<li>one when rejected filter is specified</li>
<li>one when an invalid filter is specified</li>
</ul>
<p><script src="http://gist.github.com/495397.js?file=gistfile1.rb"></script></p>
<p>I haven&#8217;t made up my mind if that spec is dreadful or not.  The whole</p>
<p>reason I&#8217;m writing this blog is that there was something about it I</p>
<p>didn&#8217;t like, but it didn&#8217;t jump out at me.</p></p>
<p>(Please note that the problem I&#8217;m illustrating here has nothing to do</p>
<p>with my use of mocks.  You&#8217;d have to write all these tests when</p>
<p>state-based testing as well.  The only difference is that your way</p>
<p>requires more setup and runs slower :P)</p></p>
<p>Like I said, the duplication wasn&#8217;t obvious to me.  I have a</p>
<p>feeling that it won&#8217;t be obvious to you either, so let me take a</p>
<p>moment to exaggerate the hell out of the code:</p>
<p><script src="http://gist.github.com/495398.js?file=gistfile1.rb"></script></p>
<p>That case statement is essentially what&#8217;s going on in our test code.</p>
<p>When we pass a certain param, a particular method gets called.</p>
<p>Repeat for every possible case.  Ugh.</p></p>
<p>My solution was to move the filter selection to the model.  It&#8217;s</p>
<p>actually a very simple change all around:</p>
<p><script src="http://gist.github.com/495400.js?file=gistfile1.rb"></script>
<p>This reduces the number of required examples from 6 down to 2:</p>
<p><script src="http://gist.github.com/495404.js?file=gistfile1.rb"></script></p>
<p>Of course, we still need to write specs for Post.filtered_repo, so we</p>
<p>haven&#8217;t reduced the total number of specs.  So what&#8217;s the point?</p></p>
<p>I wish I could give you some hardcore, compelling reasons as to why</p>
<p>this is better.  The best I can do this very moment is point to the</p>
<p>resulting code and hope that you agree it&#8217;s a significant</p>
<p>improvement.  Still, here are a couple points:</p>
<h2>Skinnier controller, fatter model</h2></p>
<p>The controller already has a bunch of work to do.  It has to populate</p>
<p>instance variables for the view, render the proper template, and</p>
<p>return an HTTP status code.  It&#8217;s almost always a good idea to assign</p>
<p>a task to another object if possible.</p>
<h2>Higher signal-noise ratio in tests</h2></p>
<p>All of the controller&#8217;s responsibilities need to be tested, as well.</p>
<p>In fact, the full spec would look like:</p>
<p><script src="http://gist.github.com/495406.js?file=gistfile1.rb"></script></p>
<p>Including examples for each filter only increases the spec&#8217;s length</p>
<p>and muddles its intent.  The short, sweet spec above clearly expresses</p>
<p>its intent.  Adding four more examples that look nearly identical</p>
<p>would make my eyes glaze over.</p>
<h2>Focused tests on the model</h2></p>
<p>This is a combination of the first two points.  I&#8217;m sure you can</p>
<p>imagine the examples you might write for Post.filtered_repo.  Because</p>
<p>Post.filtered_repo has one responsibility, the spec for it would be</p>
<p>small, cohesive and easy to understand.</p>
<h1>Conclusion</h1></p>
<p>I hope that gives you a bit of insight into the kinds of design</p>
<p>improvements you can make when you listen to your test code.  What</p>
<p>other examples do you have?</p>
