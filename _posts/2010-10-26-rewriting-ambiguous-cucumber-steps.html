---
layout: post
title: Rewriting Ambiguous Cucumber Steps
date: 2010-10-26 18:03:16.000000000 -06:00
categories: []
tags: []
status: publish
type: post
published: true
meta:
  _edit_last: '2'
  _wp_rp_related_posts_query_result_cache_expiration: '1441252325'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:2:"44";s:5:"score";s:18:"14.362837382944146";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:4:"1066";s:5:"score";s:18:"14.212483545116037";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:3:"889";s:5:"score";s:18:"10.743281433768395";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:3:"431";s:5:"score";s:18:"10.685306360664747";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:3:"260";s:5:"score";s:17:"8.720079610054293";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:3:"252";s:5:"score";s:17:"8.720079610054293";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:3:"244";s:5:"score";s:17:"8.720079610054293";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:3:"895";s:5:"score";s:17:"8.533027494746932";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:3:"222";s:5:"score";s:18:"7.7220972784591755";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:3:"970";s:5:"score";s:17:"6.276096990825636";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:3:"236";s:5:"score";s:17:"6.276096990825636";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:3:"228";s:5:"score";s:17:"6.276096990825636";}}
  _wp_rp_image: empty
  _wp_rp_related_posts_query_result_cache_4: a:8:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:3:"178";s:5:"score";s:18:"16.328336863320963";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:3:"184";s:5:"score";s:18:"15.235249450612413";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:4:"1121";s:5:"score";s:18:"14.901141281258493";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:2:"96";s:5:"score";s:18:"14.790877140103543";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"1066";s:5:"score";s:18:"14.570563764385044";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:2:"44";s:5:"score";s:16:"13.5466778305573";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:3:"166";s:5:"score";s:18:"12.787698587202666";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:3:"144";s:5:"score";s:18:"12.222846115966668";}}
author:
  login: pat
  email: patmaddox@me.com
  display_name: pat
  first_name: Pat
  last_name: Maddox
excerpt: !ruby/object:Hpricot::Doc
  options: {}
---
<p>A while ago I read some Cucumber examples that <a href="http://testobsessed.com/">Elisabeth Hendrickson</a> wrote.  I noticed something about her style that was a bit different from how I had been writing steps up to that point.  Here&#8217;s a quick example:</p>
<pre><code>Scenario: Successful registration sends email
    Given I am at the home page
    When I sign up with the email address "pat@example.com"
    Then "pat@example.com" receives an email
</code></pre>
<p>The difference is in the Then step, which I would have always written as</p>
<pre><code>    Then "pat@example.com" should receive an email
</code></pre>
<p>She says &#8220;receives&#8221; while I say &#8220;should receive.&#8221;  A holdover from all the RSpec examples I&#8217;ve written over the years, I guess.</p>
<p>I like Elisabeth&#8217;s style because it is more declarative and straight-forward.  I did have one hesitation though, and it quickly surfaced in practice as I began to adopt her style.  Some of my Given steps (meant to set up initial state) used the same language as my Then steps (meant to verify outcomes).  What do you do when the steps are ambiguous?</p>
<p>Let me show you an example of what I mean.  Here&#8217;s a version that uses the &#8220;should&#8221; language:</p>
<pre><code>Scenario: Successful registration adds user to the system
    Given there are 0 users
    When I sign up with the email address "pat@example.com"
    Then there should be 1 user
</code></pre>
<p>If I drop the should, I&#8217;ll get something like the following:</p>
<pre><code>Scenario: Successful registration adds user to the system
    Given there are 0 users
    When I sign up with the email address "pat@example.com"
    Then there is 1 user
</code></pre>
<p>Now I&#8217;ve got a problem.  Somewhere I was using the following step matcher:</p>
<pre><code>Given /^ there are 0 users$/ do
  User.destroy_all
end
</code></pre>
<p>but my Then matcher will also match that line:</p>
<pre><code>Then /^ there (?:is|are) (\d+) users?$/ do |num_users|
  User.count.should == num_users.to_i
end
</code></pre>
<p>In cases like this, I&#8217;ve begun a convention of renaming my Given steps to &#8220;Given that.&#8221;  Rewriting the example, it would be:</p>
<pre><code>    Given that there are 0 users
    When I sign up with the email address "pat@example.com"
    Then there is 1 user
</code></pre>
<p>Now I&#8217;m able to write my Then step without &#8220;should,&#8221; and Cucumber doesn&#8217;t complain about ambiguous step definitions.</p>
<p>Occasionally I will change the language of the Given step definition, if I want to handle one or two special cases.  For example, instead of writing &#8220;Given that there are 0 users&#8221; I might write &#8220;Given there are no users&#8221; and have that step definition destroy any users in the system.</p>
